<?php require_once(DIR_SYSTEM."lightning/config.php");global$light_sqltime,$Wdl,$Wgh,$Wgi,$W_,$Wdd,$Wgj;$Wdl=@disk_free_space(DIR_CACHE);if($Wdl<10)$Wdl=2*500*1024*1024;$Wgh=array("store","setting","language","currency","weight_class","length_class","category","layout_route","extension","category_to_layout","banner_image","information",/*2.0*/"event","layout_module");$Wgj=true;$Wgi=-1;function Wcu(&$driver){$Wgk=new light_db($driver);$driver=$Wgk;}class light_db{public$driver;public function __construct($driver){global$W_,$Wdd,$light_sqltime;$W_=DIR_CACHE."lightning/beta";$Wdd=$light_sqltime*60;Waz();$this->driver=$driver;}private function Wa_($Wgl,$Wgm=false){$Wgl=str_replace('`','',$Wgl);if(!$Wgl)return 0;if($Wgl!=strtolower($Wgl))return 0;static$Wgn;global$W_;if(!$Wgm and!empty($Wgn[$Wgl]))return$Wgn[$Wgl];$Wgo=$W_."/qwert";$Wab=$Wgo."/$Wgl";if($Wgm){Wba($Wgo);if(!file_exists($Wab))file_put_contents($Wab,'');touch($Wab);$Wgn[$Wgl]=time();return$Wgn[$Wgl];}if(!file_exists($Wab))$Wgn[$Wgl]=0;else$Wgn[$Wgl]=filemtime($Wab);return$Wgn[$Wgl];}private function Wbb($Wfa,$Wbc){$Wgn=array_merge(Wbc("FROM "," ",$Wfa),Wbc("JOIN "," ",$Wfa));foreach($Wgn as$Wgl){if($this->Wa_($Wgl)>=$Wbc)return false;}return true;}private function Wbd($Wfa){$Wgn=array_merge(Wbc("FROM "," ",$Wfa),Wbc("INTO "," ",$Wfa),Wbc("UPDATE "," ",$Wfa));foreach($Wgn as$Wgl){if(!preg_match("/^[a-z0-9_-]+$/",$Wgl))continue;$this->Wa_($Wgl,true);}}public function query($Wfa){static$Wgp;global$Wev,$Wew,$Wgq,$Wz,$Wgr;if(!$Wgp){$Wgp=microtime(true);$Wgs=true;}else$Wgs=false;static$Wgt;if($Wgt++>10000){$Wgt=0;global$Wep;if($Wep){$Wgu=microtime(true)-$Wep;$Wgu/=60;if($Wgu>60*10){$Wgv=debug_backtrace();$Waz="";foreach($Wgv as$Wbm=>$Wfj){$Wgw=$Wfj["function"];if($Wgw=="call_user_func_array")break;if(!empty($Wfj["class"]))$Wgw=$Wfj["class"].":".$Wgw;if(!empty($Wfj["line"]))$Wgw.=" [".$Wfj["line"]."]";if($Waz)$Waz=$Wgw." -> ".$Waz;else$Waz=$Wgw;}global$Ww;file_put_contents(DIR_CACHE."lightning/bad","\n\n\nPID: ".getmypid()." URI:".$_SERVER["REQUEST_URI"]." $Ww \n\n SQL: $Wfa \n\n Trace: $Waz",FILE_APPEND);}if($Wgu>60*11)die("Hanged, killed by Lightning");}}global$Wy,$light_optimize_backend,$Wq,$light_cache_sql,$Weq,$Wer,$light_cache_only_slow_sql,$Wgx;if($Wy&&time()-$Wy>30){global$Wgy,$Ww;if($Wgy)$Wgy->Wcr("Page generation was killed (took more then 30 sec) - ".$Ww);exit;}$Wgz=0.05;$Wg_=false;$Wha=strtoupper(substr($Wfa,0,6));global$light_optimize;if($light_optimize&&$Wha=="SELECT")if((!$Wgx or$Wq)and($light_optimize_backend or defined("LIGHT_FRONTEND"))){Wcm($Wfa);$Wg_=true;Wbe($Wfa);if(is_array($Wfa)){$Wfg=Wbf($Wfa);if($Wgq)Wc_($Wfg);if($Wgs){$Wev+=microtime(true)-$Wgp;$Wgp=false;}return$Wfg;}}if(!$light_cache_sql or$Wgx){$Weq++;$Wbc=microtime(true);$Wfg=$this->driver->query($Wfa);$Whb=microtime(true)-$Wbc;$Wew+=$Whb;if($Wz)$Wgr[]=array('bp'=>$Wfa,'bq'=>false,'br'=>$Whb,'bs'=>Wdf());if($Wgq)Wc_($Wfg);if($Wgs){$Wev+=microtime(true)-$Wgp;$Wgp=false;}return$Wfg;}$Wer++;if($Wha=="SELECT"){if(!$Wg_)Wcm($Wfa);global$Wgi;if($Wgi>=0&&strpos($Wfa,"FOUND_ROWS()")){$Whc=Wy(" as ","",$Wfa);if(!$Whc)$Whc=Wy(" AS ","",$Wfa);$Whc=str_replace("`","",$Whc);$Whc=str_replace("'","",$Whc);if(!$Whc)$Whc="FOUND_ROWS()";$Wfg=Wbf(array(array($Whc=>$Wgi)));if($Wgq)Wc_($Wfg);if($Wgs){$Wev+=microtime(true)-$Wgp;$Wgp=false;}return$Wfg;}$Wfg=Wah($Wfa);global$light_sql_frontend_delay,$Whd;if($Whd and ((defined("LIGHT_FRONTEND")and($Whd>time()-$light_sql_frontend_delay))or$this->Wbb($Wfa,$Whd))){if($Wfg!==false){$Wgi=-1;$Wfg=Wbf(unserialize($Wfg));if($Wz)$Wgr[]=array('bp'=>$Wfa,'bq'=>$Whd,'br'=>0,'bs'=>Wdf());if($Wgq)Wc_($Wfg);if($Wgs){$Wev+=microtime(true)-$Wgp;$Wgp=false;}return$Wfg;}}}elseif($Wha=="DELETE"||$Wha=="INSERT"||$Wha=="UPDATE"||$Wha=="REPLAC"){$Whe=true;if(strpos($Wfa,"SET viewed = (viewed + 1)"))$Whe=false;if($Whe)$this->Wbd($Wfa);}$Wbc=microtime(true);$Wfg=$this->driver->query($Wfa);$Weq++;$Wer--;$Whb=microtime(true)-$Wbc;$Wew+=$Whb;if($Wz)$Wgr[]=array('bp'=>$Wfa,'bq'=>false,'br'=>$Whb,'bs'=>Wdf());if($Wha=="SELECT"){if(!$light_cache_only_slow_sql||$Whb>$Wgz||Wbg($Wfa))if(!strpos(strtoupper($Wfa)," RAND()")){$Whf=$Wfg->rows;if(strpos($Wfa,"SQL_CALC_FOUND_ROWS")){$Wbc=microtime(true);$Whg=$this->driver->query("SELECT FOUND_ROWS()")->row;$Whb=microtime(true)-$Wbc;$Wew+=$Whb;$Whg=reset($Whg);$Whf['n']=$Whg;global$Wgi;$Wgi=$Whg;}$Whf=serialize($Whf);if(strlen($Whf)<1024*1024)Waf($Wfa,$Whf);}}if($Wgs){$Wev+=microtime(true)-$Wgp;$Wgp=false;}if($Wgq)Wc_($Wfg);return$Wfg;}public function Wbh($Whh){if(is_array($Whh))return array_map(__METHOD__,$Whh);if(!empty($Whh)&&is_string($Whh)){return str_replace(array('\\',"\0","\n","\r","'",'"',"\x1a"),array('\\\\','\\0','\\n','\\r',"\\'",'\\"','\\Z'),$Whh);}return$Whh;}public function escape($Wd_){if(!$this->driver)return$this->Wbh($Wd_);return$this->driver->escape($Wd_);}public function countAffected(){return$this->driver->countAffected();}public function getLastId(){return$this->driver->getLastId();}public function __destruct(){unset($this->driver);}}function Wdc($Wfc){if($Wfc<1)$Wfc=round($Wfc,3);elseif($Wfc<2)$Wfc=round($Wfc,2);elseif($Wfc<6)$Wfc=round($Wfc,1);else$Wfc=round($Wfc);return($Wfc);}function Wdd(){echo"<h2>Page Generation Metrics</h2>";global$Wep,$Weq,$Wer,$Wev,$Wew;$Wes=microtime(true)-$Wep;echo"Total: ".Wdc($Wes)." sec. <br/>";$Wex=$Wes-$Wev;echo"PHP: ".Wdc($Wex)." sec. (".round($Wex/$Wes*100)."%)<br/>";$Wey=$Wev-$Wew;echo"Beta: ".Wdc($Wey)." sec. (".round($Wey/$Wes*100)."%)<br/>";echo"SQL: ".Wdc($Wew)." sec. (".round($Wew/$Wes*100)."%)<br/>";echo"<br/>";echo"<h2>SQL Queries</h2>";echo"Cached queries: ".$Wer."<br/>";echo"Real queries: ".$Weq."<br/>";echo"<br/>";echo"<a onclick='$(\".li_hide\").show(300)'>Show All</a><br/>";echo"<style type='text/css'>.li_time {color: blue} .li_query {margin-left:20px}</style>";global$Wgr;for($Wbm=count($Wgr)-2;$Wbm>=0;$Wbm--)if($Wgr[$Wbm]['bs']['b_']==$Wgr[$Wbm+1]['bs']['b_']){$Wgr[$Wbm]['bs']['br']+=$Wgr[$Wbm+1]['bs']['br'];$Wgr[$Wbm+1]['bs']['br']=0;}$Whi="";$Whj=$Wes/100;foreach($Wgr as$Whk){if($Whk['bs']['b_']!=$Whi){$Whi=$Whk['bs']['b_'];echo"<h4";if($Whk['bs']['br']<0.001)$Whk['bs']['br']=0;if($Whk['bs']['br']<$Whj)echo" class='li_hide' style='display:none'";echo">".$Whi;if($Whk['bs']['br'])echo" <span class='li_time'>(".Wdc($Whk['bs']['br'])." sec)</span>";echo"</h4>";}if($Whk['br']<0.001)$Whk['br']=0;echo"<div class='li_query";if($Whk['br']<$Whj)echo" li_hide";echo"' style='margin-top:10px;";if($Whk['bq'])echo"color: grey;";if($Whk['br']<$Whj)echo"display:none";echo"'>";echo$Whk['bp'];if($Whk['br'])echo" <span class='li_time'>(".Wdc($Whk['br'])." sec)</span>";echo"</div>";}}function Wdg($Wet){global$Wgr;$Wgr[]=array('bp'=>"<font color='blue'>".$Wet.'<Wb_>','bq'=>false,'br'=>0,'bs'=>Wdf());}function Wcs(){if(!defined("VERSION")||VERSION<"2.0"){$Wab=DIR_DATABASE.DB_DRIVER.".php";if(file_exists($Wab)){require_once($Wab);$Whl="DB".DB_DRIVER;if(!class_exists($Whl))$Whl=DB_DRIVER;return new$Whl(DB_HOSTNAME,DB_USERNAME,DB_PASSWORD,DB_DATABASE);}else{exit("Lightning: Could not load database driver type ".DB_DRIVER.'!');}}else{$Wab=DIR_SYSTEM."library/db/".DB_DRIVER.".php";require_once($Wab);$Whl="DB\\".DB_DRIVER;if(class_exists($Whl)){return new$Whl(DB_HOSTNAME,DB_USERNAME,DB_PASSWORD,DB_DATABASE);}else{exit("Lightning: Could not load database driver ".DB_DRIVER.'!');}}}function Wbg(&$Wfa){global$Wgh;if(strpos($Wfa,"ELECT COUNT")and strpos($Wfa,"product_id) AS total"))return true;if(strpos($Wfa,"'information_id="))return true;$Wgl=Wcy("\* FROM "," ",$Wfa);if(!$Wgl){$Wgl=Wcy(" xseo FROM "," ",$Wfa);if(!$Wgl)return false;}if(substr($Wgl,0,1)=="`")$Wgl=substr($Wgl,1,-1);$Wgl=substr($Wgl,strlen(DB_PREFIX));if(!in_array($Wgl,$Wgh))return false;if($Wgl=="setting")Waz(true);return true;}global$Wgx;$Wgx=file_exists(DIR_LOGS.'ba');function Wbf($Whm){$Wdq=new stdClass();if(!$Whm){$Wdq->rows=array();$Wdq->row=array();$Wdq->num_rows=0;return$Wdq;}if(isset($Whm['n'])){global$Wgi;$Wgi=$Whm['n'];unset($Whm['n']);}$Wdq->rows=$Whm;$Wdq->num_rows=count($Whm);if($Wdq->num_rows)$Wdq->row=reset($Whm);else$Wdq->row=array();return$Wdq;}function Wbi(){foreach(glob(DIR_CACHE."lightning/".'c'."*")as$Whn)if(is_file($Whn))unlink($Whn);}function Wbj($Wbp){if(substr_count($Wbp,'/')==2)$Wbp=substr($Wbp,0,strrpos($Wbp,'/'));if(!in_array($Wbp,array("setting/setting","localisation/language","localisation/currency","catalog/category","catalog/information")))return;Wbi();}function Waz($Who=false){if(!$Who and file_exists(DIR_CACHE."lightning"))return;static$Whp;if($Whp)return;$Whp=true;global$db;if($db){Wbk('product_to_category','category_id');Wbk('url_alias','query');Wbk('url_alias','keyword');Wbk('product_option_value','product_id');Wbk('product_special','product_id');Wbk('product','model');Wbk('product_image','product_id');Wbk('product_option','product_id');}$Wbb=substr(DIR_SYSTEM,0,-7)."index.php";$Whq="lightning/gamma.php";$Web=file_get_contents($Wbb);if(strpos($Web,$Whq))return;$Wu=strpos($Web,"index.php");$Wu=strpos($Web,"}",$Wu+1);if(!$Wu)return;$Wu++;$Web=substr($Web,0,$Wu)."\n\nif (file_exists(DIR_SYSTEM.'lightning/gamma.php')) require(DIR_SYSTEM.'lightning/gamma.php'); //Lightning".substr($Web,$Wu);file_put_contents($Wbb,$Web);$Web=file_get_contents($Wbb);if(true or!strpos($Web,$Whq)){echo"<h3>Failed to activate OpenCart Lightning - <font color='blue'>$Wbb</font> not writable!</h3> Please read <a target='_blank' href='http://lightning.devs.mx/fix-index-php-problem/'>how to fix this problem</a>.";exit;}}function Wcm(&$Wfa){$Wfa=preg_replace('/\s+/',' ',$Wfa);}function Wbk($Wgl,$Whr,$Whs=false){global$db;if(!$db)return;$Wam=$Whr;if($Whs)$Wam.="_".$Whs;if($db->query("SHOW KEYS FROM `".DB_PREFIX."$Wgl` WHERE Key_name='$Wam'")->row)return;if(!$Whs)$db->query("ALTER TABLE `".DB_PREFIX."$Wgl` ADD INDEX `$Whr` (`$Whr`)");else$db->query("ALTER TABLE `".DB_PREFIX."$Wgl` ADD INDEX `$Wam` (`$Whr`,`$Whs`)");}define('Wbb',"/meters");function Wbl(){global$Wht,$Whu,$W_,$Wdd,$Wgj;if(!$Wht)$Wht=0;$Whu[$Wht][0]=$W_;$Whu[$Wht][1]=$Wdd;$Whu[$Wht][2]=$Wgj;$Wht++;}function Wbm(){global$Wht,$Whu,$W_,$Wdd,$Wgj;$Wht--;$W_=$Whu[$Wht][0];$Wdd=$Whu[$Wht][1];$Wgj=$Whu[$Wht][2];}function Wr($Whv=false,$Whw=false){global$W_;$Wab=$W_.Wbb;if(file_exists($Wab)){$Wa_=explode(',',Wbn($Wab));if(!$Whv and!$Whw)return$Wa_;$Whx=$Wa_[0];$Wat=$Wa_[1];}else{$Whx=0;$Wat=0;}$Whx+=$Whv;if($Whx<0)$Whx=0;$Wat+=$Whw;if($Wat<0)$Wat=0;file_put_contents($Wab,$Whx.','.$Wat,LOCK_EX);}function Wbn($Wab){$Why=fopen($Wab,'rt');flock($Why,LOCK_SH);$Wfg=file_get_contents($Wab);fclose($Why);return$Wfg;}function Waf($Wdz,$Wa_,$Whz=false){global$W_,$Wgj;if(Wba($W_))if($Wgj)file_put_contents($W_.Wbb,"0,0");global$Wdl,$Wc;if($Wdl<$Wc)return;$Waa=md5($Wdz);$Wgo=$W_."/".substr($Waa,0,2);if($Whz)Wcv($Wgo);$Wab=$Wgo."/c".substr($Waa,2);if($Wgj){$Whx=0;if(file_exists($Wab))$Wat=strlen($Wa_)-filesize($Wab);else{$Wat=strlen($Wa_);$Whx=1;}Wr($Whx,$Wat);}Wba($Wgo);file_put_contents($Wab,$Wa_);}function Wbo($Wab){static$Wh_;if(!$Wh_)$Wh_=phpversion();if($Wh_<"5.3")clearstatcache();else clearstatcache(true,$Wab);}function Ws($Wdz){global$W_;$Waa=md5($Wdz);$Wgo=$W_."/".substr($Waa,0,2);$Wab=$Wgo."/c".substr($Waa,2);Wbo($Wab);if(!file_exists($Wab))return false;return(filemtime($Wab));}function Wai($Wdz,$Wbc,$Who=false){global$W_;$Waa=md5($Wdz);$Wgo=$W_."/".substr($Waa,0,2);Wba($Wgo);$Wab=$Wgo."/c".substr($Waa,2);if(!file_exists($Wab)){if(!$Who)return;file_put_contents($Wab,'');global$Wgj;if($Wgj)Wr(1,0);}touch($Wab,$Wbc);}function Wah($Wdz,$Wia=false){global$W_,$Wdd,$Whd;$Whd=false;$Waa=md5($Wdz);$Wgo=$W_."/".substr($Waa,0,2);$Wab=$Wgo."/c".substr($Waa,2);if($Wdd and!$Wia)Wcv($Wgo);if(!file_exists($Wab))return false;$Whd=filemtime($Wab);$Wa_=file_get_contents($Wab);return$Wa_;}function Wcv($Wgo){global$Wdd,$Wgj;if(!$Wdd)return;if(!file_exists($Wgo))return;$Wbc=microtime(true);if(filemtime($Wgo)<$Wbc-10*60){$Wbc-=$Wdd;$Whx=0;$Wat=0;if(substr($Wgo,-1)=="/")$Wgo=substr($Wgo,0,-1);$Wib=glob($Wgo."/c*");if($Wib)foreach($Wib as$Whn){Wbo($Whn);if(filemtime($Whn)<$Wbc){$Whx++;if($Wgj)$Wat+=filesize($Whn);@unlink($Whn);}}touch($Wgo);if($Wgj)Wr(-$Whx,-$Wat);}}function Wu($Wdz=false){global$W_,$Wgj;if($Wdz){$Waa=md5($Wdz);$Wgo=$W_."/".substr($Waa,0,2);$Wab=$Wgo."/c".substr($Waa,2);if(file_exists($Wab)){Wbo($Wab);Wr(-1,filesize($Wab));unlink($Wab);}return;}foreach(glob($W_."/*")as$Wgo){if(is_dir($Wgo)){foreach(glob($Wgo."/*")as$Whn)@unlink($Whn);rmdir($Wgo);}else @unlink($Wgo);}if($Wgj and file_exists($W_.Wbb))@unlink($W_.Wbb);}function Wbc($Wcw,$Wgf,$Wcp){preg_match_all("/$Wcw([^$Wgf]*)/i",$Wcp,$Wfp);return($Wfp[1]);}function Wcy($Wcw,$Wgf,&$Wcp){preg_match("/$Wcw([^$Wgf]*)/i",$Wcp,$Wfp);if(isset($Wfp[1]))return($Wfp[1]);else return"";}function Wbp($Wcw,$Wax="",$Wcp){$Waw=array();$Wcr=0;while(($Wcr=strpos($Wcp,$Wcw,$Wcr))!==false){$Wcr+=strlen($Wcw);$Wcu=strpos($Wcp,$Wax,$Wcr);if($Wcu!==false){$Waw[]=trim(substr($Wcp,$Wcr,$Wcu-$Wcr));$Wcr=$Wcu+strlen($Wax);}}return$Waw;}function Wbq($Wic=false,$Wco='',$Wcp=false){if(($Wu=strpos($Wic,'*'))!==false){$Wcq=substr($Wic,0,$Wu);$Wct=substr($Wic,$Wu+1);$Waw=Wbr("","",$Wcq,$Wct,$Wcp);$Waw=str_ireplace($Wcq.$Wct,$Wco,$Waw);}else $Waw=str_ireplace($Wic,$Wco,$Wcp);return$Waw;}function Wbr($Wcv,$Wco,$Wcw,$Wax,$Wcp){$Wcr=0;while(($Wcr=stripos($Wcp,$Wcw,$Wcr))!==false){$Wcr+=strlen($Wcw);if($Wax)$Wcu=stripos($Wcp,$Wax,$Wcr);else$Wcu=strlen($Wcp);if($Wcu){$Wcx=substr($Wcp,0,$Wcr);$Wcy=substr($Wcp,$Wcu);$Wcz=substr($Wcp,$Wcr,$Wcu-$Wcr);$Wc_=strlen($Wcz);if($Wcv!=='')$Wcz=str_ireplace($Wcv,$Wco,$Wcz);else$Wcz=$Wco;$Wcp=$Wcx.$Wcz.$Wcy;$Wcu=$Wcu+strlen($Wcz)-$Wc_;$Wcr=$Wcu+strlen($Wax);if($Wcr>strlen($Wcp))break;}}return$Wcp;}function Wy($Wcw,$Wax="",$Wcp){$Waw='';if($Wcw)$Wcr=stripos($Wcp,$Wcw);else$Wcr=0;if($Wcr!==false){$Wcr+=strlen($Wcw);if($Wax)$Wcu=stripos($Wcp,$Wax,$Wcr);else$Wcu=strlen($Wcp);if($Wcu!==false)$Waw=trim(substr($Wcp,$Wcr,$Wcu-$Wcr));}return$Waw;}function Wba($Wid){if(file_exists($Wid))return false;Wbs();mkdir($Wid,0777,true);chmod($Wid,0777);Wbt();return true;}function Wbs(){global$config,$Wao,$Wie,$Wif;if($Wao)return;if(!$config)return;$Wao=true;$Wie=$config->get("config_error_display");$Wif=$config->get("config_error_log");$config->set("config_error_display",0);$config->set("config_error_log",0);}function Wbt(){global$config,$Wao,$Wie,$Wif;if(!$Wao)return;if(!$config)return;$Wao=false;$config->set("config_error_display",$Wie);$config->set("config_error_log",$Wif);}function Wbu($Wfa){if(strpos($Wfa,"ORDER BY p.date_added")){$Wfa=Wbq("ORDER BY p.date_added*DESC ","ORDER BY p.product_id DESC ",$Wfa." ");$Wfa=Wbq("ORDER BY p.date_added*ASC ","ORDER BY p.product_id ASC ",$Wfa);return trim($Wfa);}if(!strpos($Wfa,"FROM ".DB_PREFIX."product_to_category p2c"))return false;$Wfa=Wbq("ORDER BY p.sort_order*ASC ","ORDER BY p2c.product_id DESC ",$Wfa." ");return trim($Wfa);}function Wbv($Wfa){return array(array("total"=>0));}function Wbw($Wfa){static$Wig;if(isset($Wig[$Wfa]))return$Wig[$Wfa];$Wfg=Wbx($Wfa);$Wig[$Wfa]=$Wfg;return$Wfg;}function Wby($Wfa){$Wdq=Wcy("`query` = '","'",$Wfa);$Wih=$Wdq;global$Wii;if(!isset($Wii[$Wdq]))$Wdq=$Wfa;if(!isset($Wii[$Wdq])){$Wfg=Wbx($Wfa);if($Wfg){$Wij=reset($Wfg);if(count($Wfg)>1||count($Wij)>3)$Wii[$Wdq]=$Wfg;else{$Wfg=reset($Wfg);$Wii[$Wdq]=$Wfg["keyword"];}}else$Wii[$Wdq]=false;};$Wik=$Wii[$Wdq];if($Wik===false)return array();if(is_array($Wik))return$Wik;return array(array("query"=>$Wih,"keyword"=>$Wii[$Wdq]));}function Wbz($Wfa){global$light_group_queries;if(!$light_group_queries)return false;static$Wil,$Wgb;if(!strpos($Wfa,"ELECT DISTINCT *, pd.name")){$Wfg=Wbx($Wfa);$Wil=array();if(count($Wfg)<1024)foreach($Wfg as$Wgc)if(!empty($Wgc["product_id"]))$Wil[]=$Wgc["product_id"];return$Wfg;}$Wim=Wcy("p.product_id = '","'",$Wfa);if(!$Wim)return false;if(!empty($Wgb[$Wim]))return array($Wgb[$Wim]);if(empty($Wil)or!in_array($Wim,$Wil)){if($Wgb and count($Wgb)>1024)return false;$Wfg=Wbx($Wfa);if(count($Wfg)<1024)foreach($Wfg as$Wgc){$Wgb[$Wgc["product_id"]]=$Wgc;if(isset($Wgc["xseo"]))$Wii["product_id=".$Wgc["product_id"]]=$Wgc["xseo"];}return$Wfg;};if($Wgb and count($Wgb)>1024)return false;$Wfa=str_replace("p.product_id = '$Wim'","p.product_id IN (".implode(",",$Wil).")",$Wfa);global$config;$Wdg=$config->get("config_seo_url");if($Wdg){global$Win;if(!$Win)$Win=Wde();$Wfa=str_replace("AS discount,","AS discount, "."(SELECT `keyword` FROM ".DB_PREFIX."url_alias WHERE `query` = CONCAT('product_id=', p.product_id) $Win) as xseo,",$Wfa);}$Wfg=Wbx($Wfa);$Wil=false;global$Wii;foreach($Wfg as$Wgc){$Wgb[$Wgc["product_id"]]=$Wgc;if($Wdg){if(empty($Wgc["xseo"]))$Wgc["xseo"]=false;$Wii["product_id=".$Wgc["product_id"]]=$Wgc["xseo"];}}if(empty($Wgb[$Wim]))return false;return array($Wgb[$Wim]);}function Wb_($Wfa){$Wfa=str_replace("p2s.store_id = 0","p2s.store_id = '0'",$Wfa);$Wfa=Wbq(" AND p2s.store_id = '*'","",$Wfa);if(strpos($Wfa,"store_id"))return false;return Wbq(" LEFT JOIN ".DB_PREFIX."product_to_store p2s ON (*)","",$Wfa);}function Wca($Wfa){$Wfa=str_replace("LCASE(name)","LCASE(pd.name)",$Wfa);if(!strpos($Wfa,"pd.name")or!strpos($Wfa,"product p "))return false;if(strpos($Wfa,"as innertable"))return false;$Wfa=str_replace("LCASE(pd.name) ASC, LCASE(pd.name)","LCASE(pd.name)",$Wfa);$Wfa=str_replace("LCASE(pd.name) DESC, LCASE(pd.name)","LCASE(pd.name)",$Wfa);$Wfa=Wbq("ORDER BY pd.name","ORDER BY p.model",$Wfa);$Wfa=Wbq("LCASE(pd.name) ASC","p.model ASC",$Wfa);$Wfa=Wbq("LCASE(pd.name) DESC","p.model DESC",$Wfa);if(!strpos($Wfa,"pd.")and!strpos($Wfa,"name")){$Wfa=Wbq(" LEFT JOIN ".DB_PREFIX."product_description pd ON (*)","",$Wfa);}return$Wfa;}function Wcb($Wfa){if(strpos($Wfa,"*")or strpos($Wfa,"name"))return false;$Wfa=Wbq(" pd.language_id = '*' AND","",$Wfa);$Wfa=Wbq(" WHERE pd.language_id = '*'","",$Wfa);$Wfa=Wbq(" LEFT JOIN ".DB_PREFIX."product_description pd ON (*)","",$Wfa);if(strpos($Wfa,"pd."))return false;$Wfa=Wbq("COUNT(DISTINCT p.product_id)","COUNT(p.product_id)",$Wfa);return$Wfa;}function Wcc($Wfa){if(strpos($Wfa,"MIN(")or strpos($Wfa,"MAX(")or strpos($Wfa,"SUM("))return false;$Wfa=Wbq(" GROUP BY p.product_id","",$Wfa);return$Wfa;}function Wcd($Wio){static$Wbz;if(!$Wbz){$Wip=Wbx("SELECT category_id, parent_id FROM ".DB_PREFIX."category");$Wiq=array();$Wbz=array();foreach($Wip as$Wir){$Wiq[$Wir["category_id"]]=$Wir["parent_id"];$Wbz[$Wir["parent_id"]][]=$Wir["category_id"];}$Wis=array();foreach($Wiq as$Wit=>$Wiu)if(empty($Wbz[$Wit]))$Wis[$Wit]=true;$Wiv=true;while($Wiv){$Wiw=array();$Wiv=false;foreach($Wiq as$Wit=>$Wiu)if(!empty($Wis[$Wit])and empty($Wis[$Wiu])){if(!empty($Wbz[$Wit]))$Wbz[$Wiu]=array_unique(array_merge($Wbz[$Wiu],$Wbz[$Wit]));if(!in_array($Wiu,$Wiw))$Wiw[]=$Wiu;$Wiv=true;}foreach($Wiw as$Wir)$Wis[$Wir]=true;}}if(empty($Wbz[$Wio]))return$Wio;return$Wio.','.implode(',',$Wbz[$Wio]);}function Wda($Wa_,$Wix){static$Wiy;if(!$Wiy)$Wiy=time()-60*60;$Wa_[]=$Wix;global$Wgq,$Whd;$Wgq=implode("/",$Wa_);$Wfg=Wah($Wgq,true);if($Whd<$Wiy+rand(0,10*60))return-1;if(!is_numeric($Wfg))return-1;$Wgq=false;return$Wfg;}function Wc_($Wfg){global$Wgq;if(!isset($Wfg->row["total"])){$Wgq=false;return;}Waf($Wgq,$Wfg->row["total"]);$Wgq=false;}function Wce($Wfa){return false;}function Wcg($Wfa){$Wiz=Wcy("AND cp.path_id = '","'",$Wfa);if(!$Wiz)return false;global$config,$Wi_;if($Wi_)if(!$config->get("config_product_count")and$config->has("config_product_count")){if(strpos($Wfa,"COUNT(DISTINCT p.product_id) AS total"))return array(array("total"=>0));}$Wfa=str_replace(" FROM ".DB_PREFIX."category_path cp LEFT JOIN ".DB_PREFIX."product_to_category p2c ON (cp.category_id = p2c.category_id)"," FROM ".DB_PREFIX."product_to_category p2c",$Wfa);$Wip=Wcd($Wiz);if(strpos($Wip,','))$Wip="IN ($Wip)";else$Wip="= $Wip";$Wfa=str_replace(" AND cp.path_id = '".$Wiz."'"," AND p2c.category_id ".$Wip,$Wfa);$Wfa=str_replace(" AND `cp`.`path_id` = '".$Wiz."'"," AND p2c.category_id ".$Wip,$Wfa);return$Wfa;}function Wde(){global$config;$Wja=Wbx("SHOW COLUMNS FROM ".DB_PREFIX."url_alias LIKE 'lang'");if($Wja)return"AND lang='".$config->get("config_language_id")."' LIMIT 1";$Wja=Wbx("SHOW COLUMNS FROM ".DB_PREFIX."url_alias LIKE 'language_id'");if($Wja)return"AND language_id='".$config->get("config_language_id")."' LIMIT 1";return"LIMIT 1";}function Wch($Wfa){global$light_group_queries;if(!$light_group_queries)return false;if(!strpos($Wfa,"FROM ".DB_PREFIX."category c LEFT JOIN"))return false;static$Wip;global$config;if(!$Wip){$Wdq="SELECT * FROM ".DB_PREFIX."category c LEFT JOIN ".DB_PREFIX."category_description cd ON (c.category_id=cd.category_id) LEFT JOIN ".DB_PREFIX."category_to_store c2s ON (c.category_id = c2s.category_id) WHERE cd.language_id = '".(int)$config->get("config_language_id")."' AND c2s.store_id = '".(int)$config->get("config_store_id")."'  AND c.status = '1' ORDER BY c.sort_order, LCASE(cd.name)";global$config;$Wdg=$config->get("config_seo_url");if($Wdg){global$Win;if(!$Win)$Win=Wde();$Wdq=str_replace("* FROM","*, (SELECT `keyword` FROM ".DB_PREFIX."url_alias WHERE `query` = CONCAT('category_id=', c.category_id) $Win) as xseo FROM",$Wdq);}$Wjb=Wbx($Wdq);$Wip=array();foreach($Wjb as$Wgc){$Wgc["children"]=0;$Wip[$Wgc["category_id"]]=$Wgc;}global$Wii;foreach($Wip as$Wgc){if($Wdg){if(empty($Wgc["xseo"]))$Wgc["xseo"]=false;$Wii["category_id=".$Wgc["category_id"]]=$Wgc["xseo"];}if(isset($Wip[$Wgc["parent_id"]]))$Wip[$Wgc["parent_id"]]["children"]++;}}$Wjc=Wcy("c.parent_id = '","'",$Wfa);if($Wjc!==''){$Wfg=array();foreach($Wip as$Wgc)if($Wgc["parent_id"]==$Wjc)$Wfg[]=$Wgc;return$Wfg;}if(!$Wip)return false;$Wio=Wcy("c.category_id = '","'",$Wfa);if(!$Wio)return false;$Wfg=array();foreach($Wip as$Wgc){if($Wgc["category_id"]==$Wio){$Wfg[]=$Wgc;return$Wfg;}}return false;}function Wcf($Wic=false){$Wgv=debug_backtrace();$Waz="";foreach($Wgv as$Wbm=>$Wfj){if($Wbm<3)continue;$Wgw=$Wfj["function"];if($Wgw=="call_user_func_array")break;if(!empty($Wfj["class"]))$Wgw=$Wfj["class"].":".$Wgw;if($Waz)$Waz=$Wgw." -> ".$Waz;else$Waz=$Wgw;}if(!$Wic)return$Waz;$Wic=explode(',',$Wic);foreach($Wic as$Wjd)if(strpos($Waz,$Wjd)!==false)return true;return false;}function Wcz($Wje){$Wje=explode(", ",$Wje);$Wgv=debug_backtrace(false);foreach($Wgv as$Wbm=>$Wfj){if(empty($Wfj["class"]))continue;if(in_array($Wfj["class"],$Wje))return true;}return false;}function Wbx($Wfa){global$db,$light_optimize;$Wcj=$light_optimize;$light_optimize=false;$Wfg=$db->query($Wfa)->rows;$light_optimize=$Wcj;return$Wfg;}function Wbe(&$Wfa){global$Wjf,$Wjg;if(!$Wjf){$Wjh=DIR_CACHE."lightning/".'c'.'bd';if(!file_exists($Wjh)){$light_optimize=false;return;}$Wjf=unserialize(file_get_contents($Wjh));foreach($Wjf as&$Wji)$Wji=explode(" | ",$Wji);}if(substr($Wfa,0,6)!=="SELECT")return;$Wjg=array();foreach($Wjf as$Wam=>$Wic)if(true){$Wcm=false;foreach($Wic as$Wcs)if(strpos($Wfa,$Wcs)!==false){$Wcm=true;break;}if(!$Wcm)continue;$Wjj=$Wam($Wfa);if(is_array($Wjj)){$Wfa=$Wjj;return;}if(!$Wjj)continue;$Wfa=$Wjj;}return;}function Wdf(){$Wgv=debug_backtrace();$Waz="";foreach($Wgv as$Wbm=>$Wfj){if($Wbm<3)continue;$Wgw=$Wfj["function"];if($Wgw=="call_user_func_array")break;if(!empty($Wfj["class"]))$Wgw=$Wfj["class"].":".$Wgw;if($Waz)$Waz=$Wgw." -> ".$Waz;else$Waz=$Wgw;}$Wfg['b_']=$Waz;static$Wbc;if(!$Wbc)$Wbc=microtime(true);$Wjk=microtime(true);$Wfg['br']=$Wjk-$Wbc;$Wbc=$Wjk;return$Wfg;}